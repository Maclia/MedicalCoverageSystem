version: '3.8'

services:
  # Unified PostgreSQL Database - Serves both main and finance services
  postgres-unified:
    image: postgres:15-alpine
    container_name: medcoverage_postgres_unified
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-medical_coverage}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_MULTIPLE_DATABASES: ${POSTGRES_MULTIPLE_DATABASES:-medical_coverage_finance}
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
    volumes:
      - postgres_unified_data:/var/lib/postgresql/data
      - ./deployment/configs/init-db-unified.sql:/docker-entrypoint-initdb.d/init-db-unified.sql:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - medcoverage_unified_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres} && psql -U ${POSTGRES_USER:-postgres} -d ${POSTGRES_DB:-medical_coverage} -c 'SELECT 1;' && psql -U ${POSTGRES_USER:-postgres} -d medical_coverage_finance -c 'SELECT 1;'"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Unified Redis - Shared caching for all services
  redis-unified:
    image: redis:7-alpine
    container_name: medcoverage_redis_unified
    restart: unless-stopped
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis_unified_data:/data
    ports:
      - "${REDIS_PORT:-6379}:6379"
    networks:
      - medcoverage_unified_network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    sysctls:
      - net.core.somaxconn=65535

  # Main Backend Application
  backend-unified:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${NODE_ENV:-production}
    container_name: medcoverage_backend_unified
    restart: unless-stopped
    env_file:
      - .env.unified
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${BACKEND_PORT:-3001}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-unified:5432/${POSTGRES_DB:-medical_coverage}
      REDIS_URL: redis://redis-unified:6379
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      UPLOAD_DIR: /app/uploads
      MAX_FILE_SIZE: ${MAX_FILE_SIZE:-10485760}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      FINANCE_SERVICE_URL: http://finance-unified:5000
    ports:
      - "${BACKEND_PORT:-3001}:3001"
    volumes:
      - uploads_unified:/app/uploads
      - logs_unified:/app/logs
    networks:
      - medcoverage_unified_network
    depends_on:
      postgres-unified:
        condition: service_healthy
      redis-unified:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/api/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'

  # Finance Service
  finance-unified:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${NODE_ENV:-production}
    container_name: medcoverage_finance_unified
    restart: unless-stopped
    env_file:
      - .env.unified
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      PORT: ${FINANCE_PORT:-5000}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-unified:5432/medical_coverage_finance
      REDIS_URL: redis://redis-unified:6379
      REDIS_KEY_PREFIX: finance:
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000}
      # Finance-specific configuration
      FINANCE_SERVICES_ENABLED: ${FINANCE_SERVICES_ENABLED:-true}
      BILLING_SERVICE_ENABLED: ${BILLING_SERVICE_ENABLED:-true}
      PAYMENT_SERVICE_ENABLED: ${PAYMENT_SERVICE_ENABLED:-true}
      COMMISSION_SERVICE_ENABLED: ${COMMISSION_SERVICE_ENABLED:-true}
      CLAIMS_FINANCIAL_SERVICE_ENABLED: ${CLAIMS_FINANCIAL_SERVICE_ENABLED:-true}
      FINANCE_API_KEY: ${FINANCE_API_KEY}
      FINANCE_WEBHOOK_SECRET: ${FINANCE_WEBHOOK_SECRET}
    ports:
      - "${FINANCE_PORT:-5000}:5000"
    volumes:
      - finance_uploads_unified:/app/uploads
      - finance_logs_unified:/app/logs
      - finance_backups_unified:/app/backups
    networks:
      - medcoverage_unified_network
    depends_on:
      postgres-unified:
        condition: service_healthy
      redis-unified:
        condition: service_healthy
      backend-unified:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health", "&&", "curl", "-f", "http://localhost:5000/api/finance/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.25'
        reservations:
          memory: 256M
          cpus: '0.125'

  # Frontend Application
  frontend-unified:
    build:
      context: ./client
      dockerfile: Dockerfile
      target: ${NODE_ENV:-production}
    container_name: medcoverage_frontend_unified
    restart: unless-stopped
    env_file:
      - .env.unified
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      VITE_API_URL: ${VITE_API_URL:-http://localhost:3001}
      VITE_FINANCE_URL: ${VITE_FINANCE_URL:-http://localhost:5000}
      VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:3001}
      GENERATE_SOURCEMAP: ${GENERATE_SOURCEMAP:-false}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    volumes:
      - static_files_unified:/app/dist
    networks:
      - medcoverage_unified_network
    depends_on:
      backend-unified:
        condition: service_healthy
      finance-unified:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

  # Unified Nginx Reverse Proxy
  nginx-unified:
    image: nginx:alpine
    container_name: medcoverage_nginx_unified
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./deployment/configs/nginx-unified.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/configs/ssl:/etc/nginx/ssl:ro
      - static_files_unified:/var/www/static:ro
      - nginx_logs_unified:/var/log/nginx
    networks:
      - medcoverage_unified_network
    depends_on:
      backend-unified:
        condition: service_healthy
      finance-unified:
        condition: service_healthy
      frontend-unified:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.125'

  # Background Job Processor (Unified)
  worker-unified:
    build:
      context: .
      dockerfile: Dockerfile
      target: ${NODE_ENV:-production}
    container_name: medcoverage_worker_unified
    restart: unless-stopped
    command: ["npm", "run", "worker"]
    env_file:
      - .env.unified
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-unified:5432/${POSTGRES_DB:-medical_coverage}
      REDIS_URL: redis://redis-unified:6379
      FINANCE_DATABASE_URL: postgres://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@postgres-unified:5432/medical_coverage_finance
      JWT_SECRET: ${JWT_SECRET}
      WORKER_CONCURRENCY: ${WORKER_CONCURRENCY:-5}
    volumes:
      - uploads_unified:/app/uploads
      - finance_uploads_unified:/app/uploads/finance
      - logs_unified:/app/logs
      - finance_logs_unified:/app/logs/finance
    networks:
      - medcoverage_unified_network
    depends_on:
      postgres-unified:
        condition: service_healthy
      redis-unified:
        condition: service_healthy
      backend-unified:
        condition: service_healthy
      finance-unified:
        condition: service_healthy
    deploy:
      replicas: ${WORKER_REPLICAS:-2}
      resources:
        limits:
          memory: 512M
          cpus: '0.25'
        reservations:
          memory: 256M
          cpus: '0.125'

  # Database Backup Service (Unified)
  backup-unified:
    image: postgres:15-alpine
    container_name: medcoverage_backup_unified
    restart: unless-stopped
    environment:
      PGPASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_HOST: postgres-unified
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      BACKUP_SCHEDULE: ${BACKUP_SCHEDULE:-0 2 * * *}
      BACKUP_RETENTION_DAYS: ${BACKUP_RETENTION_DAYS:-30}
    volumes:
      - backups_unified:/backups
      - ./deployment/scripts:/scripts:ro
    command: >
      sh -c "
        echo 'Unified database backup service initialized' &&
        echo 'Backup schedule: ${BACKUP_SCHEDULE}' &&
        echo 'Retention period: ${BACKUP_RETENTION_DAYS} days' &&
        echo 'Monitoring databases: medical_coverage, medical_coverage_finance' &&
        tail -f /dev/null
      "
    networks:
      - medcoverage_unified_network
    depends_on:
      postgres-unified:
        condition: service_healthy
    profiles:
      - backup

  # Monitoring Service (Optional)
  monitoring:
    image: prom/prometheus:latest
    container_name: medcoverage_monitoring
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9090}:9090"
    volumes:
      - ./deployment/configs/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - medcoverage_unified_network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    profiles:
      - monitoring

volumes:
  postgres_unified_data:
    driver: local
  redis_unified_data:
    driver: local
  uploads_unified:
    driver: local
  finance_uploads_unified:
    driver: local
  logs_unified:
    driver: local
  finance_logs_unified:
    driver: local
  finance_backups_unified:
    driver: local
  backups_unified:
    driver: local
  static_files_unified:
    driver: local
  nginx_logs_unified:
    driver: local
  prometheus_data:
    driver: local

networks:
  medcoverage_unified_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1