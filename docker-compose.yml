version: '3.9'

services:
  postgres:
    image: postgres:15-alpine
    container_name: mcs-postgres
    environment:
      POSTGRES_USER: mcs
      POSTGRES_PASSWORD: mcs
      POSTGRES_DB: mcs_meta
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U mcs"]
      interval: 10s
      timeout: 5s
      retries: 5

  pgadmin:
    image: dpage/pgadmin4:8
    container_name: mcs-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@example.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8081:80"
    depends_on:
      - postgres

  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    image: medical-coverage/api-gateway:latest
    container_name: api-gateway
    environment:
      NODE_ENV: production
      PORT: 8080
      # Example of service URLs via docker DNS
      BILLING_SERVICE_URL: http://billing-service:3000
      FINANCE_SERVICE_URL: http://finance-service:3000
      HOSPITAL_SERVICE_URL: http://hospital-service:3000
      INSURANCE_SERVICE_URL: http://insurance-service:3000
      MEMBERSHIP_SERVICE_URL: http://membership-service:3000
      CRM_SERVICE_URL: http://crm-service:3000
      WELLNESS_SERVICE_URL: http://wellness-service:3000
      JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY:-changeme}
    ports:
      - "8080:8080"
    depends_on:
      - billing-service
      - finance-service
      - hospital-service
      - insurance-service
      - membership-service
      - crm-service
      - wellness-service

  billing-service:
    build:
      context: ./services/billing-service
      dockerfile: Dockerfile
    image: medical-coverage/billing-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/billing
    depends_on:
      postgres:
        condition: service_healthy

  finance-service:
    build:
      context: ./services/finance-service
      dockerfile: Dockerfile
    image: medical-coverage/finance-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/finance
    depends_on:
      postgres:
        condition: service_healthy

  hospital-service:
    build:
      context: ./services/hospital-service
      dockerfile: Dockerfile
    image: medical-coverage/hospital-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/hospital
    depends_on:
      postgres:
        condition: service_healthy

  insurance-service:
    build:
      context: ./services/insurance-service
    image: medical-coverage/insurance-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/insurance
    depends_on:
      postgres:
        condition: service_healthy

  membership-service:
    build:
      context: ./services/membership-service
      dockerfile: Dockerfile
    image: medical-coverage/membership-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/membership
    depends_on:
      postgres:
        condition: service_healthy

  crm-service:
    build:
      context: ./services/crm-service
      dockerfile: Dockerfile
    image: medical-coverage/crm-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/crm
    depends_on:
      postgres:
        condition: service_healthy

  wellness-service:
    build:
      context: ./services/wellness-service
      dockerfile: Dockerfile
    image: medical-coverage/wellness-service:latest
    environment:
      NODE_ENV: production
      PORT: 3000
      DATABASE_URL: postgres://mcs:mcs@postgres:5432/wellness
    depends_on:
      postgres:
        condition: service_healthy

  client:
    build:
      context: ./client
      dockerfile: Dockerfile
    image: medical-coverage/client:latest
    container_name: client
    environment:
      NODE_ENV: production
      VITE_API_BASE_URL: http://localhost:8080
    ports:
      - "5173:80"
    depends_on:
      - api-gateway

volumes:
  pgdata:
